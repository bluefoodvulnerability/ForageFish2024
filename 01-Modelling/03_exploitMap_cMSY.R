# 00. Loading Packages ----------------------------------------------------

# sourcing support function
source('./00-Support Functions/01_supportCMSY.R')

# 01 Preparing jobs, read in tidied landing data, generate stock list ----------
FFCatch_tidy_path <- './03-Input/ff.landing.csv'

FFCatch_tidy <- read_csv(FFCatch_tidy_path)
stockList <- unique(FFCatch_tidy$stock)

# 02 modified cmsy loop ---------------------------------------------------
# C-msy model
# First run using narrow r range
FFCatch_n <- FFCatch_tidy %>%
    nest(data=c(yridx, Year, catch))

tic()
plan(multisession, workers = 35)
FFasses_cmsy <- FFCatch_n %>%
    mutate(model = future_map(data, nestedCMSY,
                              rlow = 0.5, rhi = 1.2,
                              .progress = F))
toc() #long run: 5.79 days

# Saving results to rds file for convenience
write_rds(FFasses_cmsy, './Results/FF.stock.cmsy.01.rds',
          compress = 'gz')
# Wider range for unassessed stocks
# If above NOT RUN
# FFasses_cmsy <- read_rds('./Data/FF_depletion_model/cmsyRes.rds')

#
tic()
clus <- new_cluster(30)
preDivideCmsy <- FFasses_cmsy %>%
    partition(clus) %>%
    group_by(stock) %>%
    filter(model == "NA") %>%
    collect()
toc()

NADivideCmsy <- preDivideCmsy
reCalList <- preDivideCmsy$stock
# writeLines(reCalList, "./Results/FF.stock.cmsy.02.stock.list")

FFCatch_n_recal <- FFCatch_tidy %>%
    nest(data=c(yridx, Year, catch)) %>%
    filter(stock %in% reCalList)

tic()
plan(multisession, workers = 30)
FFasses_cmsy_recal <- FFCatch_n_recal %>%
    mutate(mode_recal = future_map(data,
                                    nestedCMSY,
                                    rlow = 0.01,
                                    rhi = 2,
                                    .progress = F))
toc()
# Saving results to rds file for convinience
write_rds(FFasses_cmsy_recal, 
          './Results/FF.stock.cmsy.02.rds')

# 03 Clean up and other  ----------------------------------------------
# If above NOT RUN
# FFasses_cmsy <- readr::read_rds('./Data/FF_depletion_model/cmsyRes.rds') # First Calculation;
# FFasses_cmsy_recal <- readr::read_rds('./Data/FF_depletion_model/cmsy_reCal.rds')


# clean up model results with narrow range
plan(multisession, workers = 6)
tic()
preCmsy_narrow <- FFasses_cmsy %>%
    transmute(stock, ref_ts = future_map(model, extr_RefTsFunc, .progress = T),
              ref_pts = future_map(model, extr_RefPtsFunc, .progress = T))
toc()

# unnest ref_ts
Cmsy_narrow_refTs <- preCmsy_narrow %>%
    filter(!is.null(ref_ts) & ref_ts != 'NULL') %>%
    select(-ref_pts)

Cmsy_narrow_refTs <- Cmsy_narrow_refTs %>%
    unnest(ref_ts) %>%
    unnest(ref_ts)

# clean up model results with wide range
plan(multisession, workers = 6)
tic()
preCmsy_wider <- FFasses_cmsy_recal %>%
    transmute(stock,
              ref_ts = future_map(mode_recal, extr_RefTsFunc, .progress = T),
              ref_pts = future_map(mode_recal, extr_RefPtsFunc, .progress = T))
toc()

Cmsy_wider_refTs <- preCmsy_wider %>%
    filter(!is.null(ref_ts) & ref_ts != 'NULL') %>%
    select(-ref_pts)

Cmsy_wider_refTs <- Cmsy_wider_refTs %>%
    unnest(ref_ts) %>%
    unnest(ref_ts)

# Gather up results
Cmsy_res_refTs <- Cmsy_narrow_refTs %>%
    bind_rows(Cmsy_wider_refTs) %>%
    separate(stock, c('spe', 'FAO_area'), '-', remove = F)

# Check results
length(unique(Cmsy_res_refTs$stock))
length(unique(Cmsy_res_refTs$spe))

# write total results to rds file
write_rds(Cmsy_res_refTs, './Results/FF.cmsy.refPts.rds')

# 02. Stock status classification ----------------------------------------------
# if above Not Run
# Cmsy_res_refTs <- readr::read_rds('./Data/Res_cmsy.rds')

# using 10-years average
stockStatus <- Cmsy_res_refTs %>%
    filter((year > 2012) & (year <= 2022)) %>%
    group_by(stock) %>%
    summarise(s_mean = mean(s, na.rm = T)) %>%
    mutate(status = case_when(s_mean >= 0.75 ~ 'Developing',
                              s_mean <= 0.75 & s_mean >= 0.25 ~ 'Fully-exploited',
                              s_mean <= 0.25 & s_mean > 0.1 ~ 'Over-exploited',
                              s_mean <= 0.1 ~ 'Collapsed')) %>%
    separate(stock, c('spe', 'FAO_area'), '-', remove = F) %>%
    ungroup()
stockStatus <- stockStatus %>%
    filter(!is.na(s_mean))

length(unique(stockStatus$spe))
length(unique(stockStatus$stock))

# write stock status to rds file
write_rds(stockStatus, 
          './Results/FF.cmsy.stock.status.rds')

writeLines(unique(stockStatus$spe), 
           "./Results/FF.cmsy.status.species.list")
writeLines(stockStatus$spe, 
           "./Results/FF.cmsy.status.stock.list")
